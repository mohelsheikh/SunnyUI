
// Step 1: Initialize a collection to track the running totals
ClearCollect(
    colIATotals,
    AddColumns(
        colSelectedItems,
        "Running_Current_Total", 0
    )
);

// Step 2: Loop through each household account and assign it to an IA
ForAll(
    colMySelectedIAHHLevelList,
    // Find the first IA where the running total is less than the target
    With(
        {
            iaRecord: First(
                SortByColumns(
                    Filter(
                        colIATotals,
                        Running_Current_Total < Target_AUM
                    ),
                    "Running_Current_Total"
                )
            ),
            updatedTotal: iaRecord.Running_Current_Total + ThisRecord.Total_AUM
        },
        // If we found a valid IA
        If(
            !IsBlank(iaRecord),
            // Assign the household account to this IA
            Patch(
                colMySelectedIAHHLevelList,
                ThisRecord,
                {
                    To_IA_Code: iaRecord.IA_Code,
                    To_IA_Name: iaRecord.IA_Name,
                    IA_Licensing: iaRecord.IA_Licensing,
                    Running_Current_Total: updatedTotal
                }
            );

            // Update the running total for this IA in colIATotals
            Patch(
                colIATotals,
                LookUp(
                    colIATotals,
                    IA_Code = iaRecord.IA_Code
                ),
                {
                    Running_Current_Total: updatedTotal
                }
            )
        )
    )
);
