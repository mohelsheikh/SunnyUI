// Step 1: Initialize colAssigned collection to keep track of assignments
ClearCollect(
    colAssigned,
    AddColumns(
        colSelectedItems,
        "Household_ID", Blank(),
        "Current_Total", Blank(),
        "To_IA_Code", Blank(),
        "To_IA_Name", Blank(),
        "IA_Licensing", Blank()
    )
);

// Step 2: Loop through each IA in colSelectedItems
ForAll(
    colSelectedItems,
    ForAll(
        Filter(
            colMySelectedIAHHLevelList,
            IsBlank(To_IA_Code) // Only consider households that haven't been assigned yet
        ),
        If(
            Sum(
                Filter(colAssigned, IA_Code = ThisRecord.IA_Code),
                Current_Total
            ) + ThisRecord.Current_Total <= ThisRecord.Target_AUM,
            Collect(
                colAssigned,
                {
                    ID: ThisRecord.ID,
                    IA_Code: ThisRecord.IA_Code,
                    Target_AUM: ThisRecord.Target_AUM,
                    IA_Licensing: ThisRecord.IA_Licensing,
                    Household_ID: colMySelectedIAHHLevelList[@ID],
                    Current_Total: colMySelectedIAHHLevelList[@Current_Total],
                    To_IA_Code: ThisRecord.IA_Code,
                    To_IA_Name: ThisRecord.IA_Name,
                    IA_Licensing: ThisRecord.IA_Licensing
                }
            );
            Patch(
                colMySelectedIAHHLevelList,
                LookUp(colMySelectedIAHHLevelList, ID = colMySelectedIAHHLevelList[@ID]),
                {
                    To_IA_Code: ThisRecord.IA_Code,
                    To_IA_Name: ThisRecord.IA_Name,
                    IA_Licensing: ThisRecord.IA_Licensing
                }
            );
            Exit()
        )
    )
);

// Step 3: Loop through colAssigned and update colMySelectedIAHHLevelList
ForAll(
    colAssigned,
    Patch(
        colMySelectedIAHHLevelList,
        LookUp(colMySelectedIAHHLevelList, ID = Household_ID),
        {
            To_IA_Code: To_IA_Code,
            To_IA_Name: To_IA_Name,
            IA_Licensing: IA_Licensing,
            Current_Total: Sum(
                Filter(colAssigned, Household_ID = ThisRecord.Household_ID),
                Current_Total
            )
        }
    )
);

