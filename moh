ClearCollect(
    colIATotals,
    AddColumns(
        colSelectedItems,
        "Running_Current_Total", 0
    )
);

ForAll(
    colIATotals,
    With(
        {
            currentIA: ThisRecord
        },
        ForAll(
            Filter(
                colMySelectedIAHHLevelList,
                IsBlank(To_IA_Code)  // Only assign accounts that haven't been assigned yet
            ),
            With(
                {
                    updatedTotal: currentIA.Running_Current_Total + ThisRecord.Total_AUM
                },
                If(
                    updatedTotal <= currentIA.Target_AUM,
                    Patch(
                        colMySelectedIAHHLevelList,
                        ThisRecord,
                        {
                            To_IA_Code: currentIA.IA_Code,
                            To_IA_Name: currentIA.IA_Name,
                            IA_Licensing: currentIA.IA_Licensing,
                            Running_Current_Total: updatedTotal
                        }
                    );
                    Patch(
                        colIATotals,
                        LookUp(
                            colIATotals,
                            IA_Code = currentIA.IA_Code
                        ),
                        {
                            Running_Current_Total: updatedTotal
                        }
                    )
                )
            )
        )
    )
);
