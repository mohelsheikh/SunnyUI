// Step 1: Initialize colAssigned collection to keep track of assignments
ClearCollect(
    colAssigned,
    {
        ID: Blank(),
        IA_Code: Blank(),
        Target_AUM: Blank(),
        IA_Licensing: Blank(),
        Household_ID: Blank(),
        Current_Total: Blank(),
        To_IA_Code: Blank(),
        To_IA_Name: Blank(),
        IA_Licensing_Assigned: Blank()
    }
);

// Step 2: Loop through each IA in colSelectedItems
ForAll(
    colSelectedItems,
    // Store current IA details in local variables
    Collect(
        colIAWorkingSet,
        {
            IA_ID: ID,
            IA_Code: IA_Code,
            Target_AUM: Target_AUM,
            IA_Licensing: IA_Licensing,
            IA_Name: IA_Name
        }
    );

    ForAll(
        Filter(
            colMySelectedIAHHLevelList,
            IsBlank(To_IA_Code) // Only consider households that haven't been assigned yet
        ),
        // Check if adding this household would exceed the IA's Target_AUM
        If(
            Sum(
                Filter(colAssigned, IA_Code = First(colIAWorkingSet).IA_Code),
                Current_Total
            ) + ThisRecord.Current_Total <= First(colIAWorkingSet).Target_AUM,
            // Collect the assignment into colAssigned
            Collect(
                colAssigned,
                {
                    ID: First(colIAWorkingSet).IA_ID,
                    IA_Code: First(colIAWorkingSet).IA_Code,
                    Target_AUM: First(colIAWorkingSet).Target_AUM,
                    IA_Licensing: First(colIAWorkingSet).IA_Licensing,
                    Household_ID: ID,
                    Current_Total: ThisRecord.Current_Total,
                    To_IA_Code: First(colIAWorkingSet).IA_Code,
                    To_IA_Name: First(colIAWorkingSet).IA_Name,
                    IA_Licensing_Assigned: First(colIAWorkingSet).IA_Licensing
                }
            );

            // Optionally, immediately update the household entry in colMySelectedIAHHLevelList
            Patch(
                colMySelectedIAHHLevelList,
                LookUp(colMySelectedIAHHLevelList, ID = ThisRecord.ID),
                {
                    To_IA_Code: First(colIAWorkingSet).IA_Code,
                    To_IA_Name: First(colIAWorkingSet).IA_Name,
                    IA_Licensing: First(colIAWorkingSet).IA_Licensing
                }
            );
        )
    )
);

// Step 3: Loop through colAssigned and update colMySelectedIAHHLevelList
ForAll(
    colAssigned,
    Patch(
        colMySelectedIAHHLevelList,
        LookUp(colMySelectedIAHHLevelList, ID = Household_ID),
        {
            To_IA_Code: To_IA_Code,
            To_IA_Name: To_IA_Name,
            IA_Licensing: IA_Licensing_Assigned,
            Current_Total: Sum(
                Filter(colAssigned, Household_ID = ThisRecord.Household_ID),
                Current_Total
            )
        }
    )
);

