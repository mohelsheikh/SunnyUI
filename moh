// Step 1: Initialize the collection to track running totals
ClearCollect(
    colIATotals,
    AddColumns(
        colSelectedItems,
        "Running_Current_Total", 0
    )
);

// Step 2: Loop through each household account and assign it to an IA
ForAll(
    colMySelectedIAHHLevelList,
    // Find the first IA where the running total is less than the target
    ForAll(
        Filter(
            colIATotals,
            Running_Current_Total < Target_AUM
        ),
        If(
            ThisRecord.Total_AUM + Running_Current_Total <= Target_AUM,
            Patch(
                colMySelectedIAHHLevelList,
                LookUp(colMySelectedIAHHLevelList, ID = ThisRecord.ID),
                {
                    To_IA_Code: ThisRecord.IA_Code,
                    To_IA_Name: ThisRecord.IA_Name,
                    IA_Licensing: ThisRecord.IA_Licensing,
                    Running_Current_Total: ThisRecord.Total_AUM + Running_Current_Total
                }
            );

            // Update the running total for this IA in colIATotals
            Patch(
                colIATotals,
                LookUp(colIATotals, IA_Code = ThisRecord.IA_Code),
                {
                    Running_Current_Total: ThisRecord.Total_AUM + Running_Current_Total
                }
            );
            
            // Exit the loop after assigning this household
            Exit()
        )
    )
);

